# 网络层协议及IP编址

## 网络层协议

### 常见网络层协议

#### 网络层协议

网络层经常被称为IP层

包括IP寻址 路由选择 ICMP IPX IP  常用是两边的

#### IP协议(Internet Protocol)

本身是一个协议文件的名称，定义报文到达网络层之后进行封装的内容有哪些，这个是协议本身所定义的

作用 ： 提供逻辑地址 负责数据包寻址和转发

#### 数据封装

![image-20240929092408318](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929092408318.png)

#### IPv4报文格式

总长包括头部到用户数据一段 总长-头部长度就是传输层及以上的内容了 头部长度固定20字节 可选字段0-40B 

![image-20240929092623568](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929092623568.png)

#### 数据片分段

![image-20240929092756909](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929092756909.png)

#### 生存时间

TTL设置了数据包可以经过的路由器数目 防止环路 8bit 0-255

![image-20240929093014867](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929093014867.png)

#### 协议号(Protocol)

![image-20240929093052216](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929093052216.png)

## Ipv4地址介绍

#### IPv4地址定义

##### 什么是IP地址

IP地址在网络中标识一个节点  用于报文在网络中的寻址 32bit 网络部分+主机部分 

![image-20240929111147189](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929111147189.png)

![image-20240929111341600](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929111341600.png)

#### IPv4地址分类方式

![image-20240929111522356](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929111522356.png)



![image-20240929113454828](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929113454828.png)

![image-20240929114017427](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929114017427.png)

![image-20240929114215620](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929114215620.png)

![image-20240929114323995](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929114323995.png)

## 子网划分

子网划分的原因是 **地址浪费** 且 **广播域太庞大**

实际上还是以最多PC数为基础的子网划分，只要满足最大的PC数，剩下的肯定都可以满足，

## ICMP协议

IP的辅助协议 用来在网络设备之间传递差错和控制信息

![image-20240929145140389](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929145140389.png)

- 网络层使用ICMP 允许主机或设备报告差错情况和提供有关异常情况的报告
- ICMP消息
  - 封装在IP报文中， 头部Protocol为1
  - 字段解释：
    - ICMP消息格式取决于**Type**和**Code**字段，Type为**具体类型**，Code包含该消息**类型的具体参数**
    - 校验和字段用于检查消息是否完整
    - 消息中包含32位的可变参数，该字段一般不使用，通常设置为0
      - 在ICMP重定向消息中，这个字段用来指定网关IP地址，主机根据这个地址将报文重定向到指定网关。
      - 在Echo Request消息中，这个字段包含标识符和序号，源端根据这两个参数将收到的回复消息与本端发送的Echo请求消息进行关联。当源端向目的端发送了多个Echo请求消息时，需要根据标识符和序号将Echo请求和回复消息进行一一对应。

### 重定向

是控制报文中的一种，当路由器检测到一台机器使用非最优路由的时候，会向该主机发送一个ICMP重定向报文，请求主机改变路由。

![image-20240929150135103](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929150135103.png)

> ICMP重定向过程： 
>
> 1. 主机A希望发送报文到服务器A，于是根据配置的默认网关地址向网关RTB发送报文。 
> 2.  网关RTB收到报文后，检查报文信息，发现报文应该转发到与源主机在同一网段的另 一个网关设备RTA，此转发路径是更优的路径，所以RTB会向主机发送一个Redirect 消息，通知主机直接向另一个网关RTA发送该报文。 
> 3. 主机收到Redirect消息后，会向RTA发送报文，然后RTA会将该报文再转发给服务器 A。

### ICMP差错检测

Echo消息用来**诊断源和目的地之间的网络连通性**，同时提供其他信息，例如报文往返时间

一个典型引用是`ping`，它是检测网络连通性的常用工具，同时也能收集其他相关信息。用户可以在ping中指定不同参数，如报文长度、报文个数、等待回复相应的超时时间等。

![image-20240929150453928](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929150453928.png)

### ICMP错误报告

![image-20240929150539954](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929150539954.png)

> • ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判 断出数据传输失败的原因。
>
> ​	 ▫ 如果网络中发生了环路，导致报文在网络中循环，且最终TTL超时，这种情况下网络 设备会发送TTL超时消息给发送端设备。
>
> ​	 ▫ 如果目的地不可达，则中间的网络设备会发送目的不可达消息给发送端设备。目的不 可达的情况有多种，如果是网络设备无法找到目的网络，则发送目的网络不可达消息； 如果网络设备无法找到目的网络中的目的主机，则发送目的主机不可达消息。
>
>  • ICMP的另一个典型应用是Tracert。Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路 径。为了跟踪到达某特定目的地址的路径，源端首先将报文的TTL值设置为1。该报文到达 第一个节点后，TTL超时，于是该节点向源端发送TTL超时消息，消息中携带时间戳。然后 源端将报文的TTL值设置为2，报文到达第二个节点后超时，该节点同样返回TTL超时消息， 以此类推，直到报文到达目的地。这样，源端根据返回的报文中的信息可以跟踪到报文经 过的每一个节点，并根据时间戳信息计算往返时间。

## IPv4地址配置及基本应用

### 基础配置命令

![image-20240929150708511](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929150708511.png)

### 网络IP地址规划

![image-20240929150809323](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20240929150809323.png)