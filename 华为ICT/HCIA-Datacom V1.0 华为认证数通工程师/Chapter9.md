# IP路由基础

主要内容是数据在不同网段当中的通信

## 路由概述

### 路由基本概念

#### 背景：网段间通信

IP地址唯一标识了网络当中的一个节点，每个网段可能是不同的区域。

为实现IP寻址，分布在不同区域的网段能够相互通信



每个路由器不仅要知道我的接口所能到达的网段，还要知道接口所达不到的网段。

#### 路由

 ![image-20241008110358583](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241008110358583.png)

![image-20241008112434643](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241008112434643.png)

路由中包含以下信息

- 目的网络：表示目的网段
- 掩码：与目的地址共同标识一个网段
- 出接口：数据包被路由后离开本路由器的接口
- 下一跳：路由器转发到达目的网段的数据包所使用的下一跳地址

#### 路由表

每个路由器里面都会有一个路由表，通过路由表查询下一跳地址。

- 路由器通过各种方式发现路由
- 路由器选择最优的路由条目放入路由表中
- 路由表指导设备对IP报文的转发
- 路由器通过对路由表的管理实现对路径信息的管理

### 路由条目生成

生成有三种方式：直连路由、静态路由、动态路由

直连路由指的是由设备自动生成指向本地直连的网络，路由器和路由器或者和PC连接，配置对应的IP地址，通过接口获取。

![image-20241013104452797](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013104452797.png)

并不是所有接口生成的直连路由都会出现在路由表中，直连路由的出现在路由表中的前提是该接口的物理和协议状态都是UP

### 最优路由条目优选

![image-20241013105436714](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013105436714.png)

Direct代表直连 Cost开销 Flag是路由的标志，应该是在建立路由表阶段和建立完成的结果是不一样的。

![image-20241013105940477](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013105940477.png)

#### 路由优先级

优先级比较

如果网段和掩码都是相同的，才会出现优先级的这个概念，优先级高的会被加入路由表，如果不相同，那么都会被加入

##### 常见默认数值

路由来源：直连路由 优先级0

静态路由 优先级60

OSPF内部路由 优先级10

OSPF外部路由 优先级150

除了0不能修改之外，剩下的都可以进行修改从而指定对应的路由方式

##### 度量值

首先看目的地址是不是同一个

先优先级，后度量值

度量值越小越优先

![image-20241013110834919](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013110834919.png)

### 路由转发

最长匹配原则

![image-20241013111413357](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013111413357.png)

便于以最短的最快捷的方式对数据进行转发

前面是控制层面的内容 这个是转发层面的内容

主要是用掩码匹配 掩码最长的匹配原则



匹配转发表的时候要从路由表一条一条匹配，从第一条到最后一条，谨防漏掉

## 静态路由

配置方便，对系统要求低 用于拓扑结构简单且稳定的小型网络

不能适应网络拓扑的变化，需要人工干预

![image-20241013141848849](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013141848849.png)

在A上没有20.1.1.0/24的报文，在只有直连路由的情况下没有路由匹配，这个时候需要手动配置静态路由，使RTA发送前往20网段的报文交给下一跳10网段转发



#### 静态路由配置

1.关联下一跳的方式

---

[Huawei] **ip route-static** *ip-address {mask | mask-length} nexthop-address*

---

2.关联出接口的方式

---

[Huawei]**ip route-static** *ip-address { mask| mask-length} interface-type interfacee-number*

---

3.关联出口和下一跳的方式

---

[Huawei]**ip route-staic** *ip-address { mask | mask-length} interface-type interface-number [nexthop-address]*

---

在创建静态路由时，可以同时指定出接口和下一跳。对于不同的出接口类型，也可以只指定出接口或只指定下一跳。 对于点到点接口（如串口），必须指定出接口。 对于广播接口（如以太网接口）和VT（Virtual-template）接口，必须指定下一跳。

![image-20241013143622092](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013143622092.png)

#### 缺省路由

• 缺省路由是一种特殊的路由，当报文**没有在路由表中找到匹配的具体路由表项**时才使用的路由。如果报文的**目的地址**不能与路由表的任何目的地址相**匹配**，那么该报文将选取缺省路由进行转发。 

• 缺省路由在路由表中的形式为0.0.0.0/0，缺省路由也被叫做默认路由。

![image-20241013143750862](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013143750862.png)

![image-20241013143947512](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013143947512.png)

## 动态路由

有自己的路由算法，能自动适应网络拓扑的变化，适用具有一定数量三层设备的网络

当网络规模越来越大时，手动配置会更复杂，且不能灵活响应

能够自动发现和生成路由，并在拓扑变化时更新路由，有效减少管理人员工作量，适用于大规模网络。

![image-20241013144245655](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013144245655.png)

> • 根据路由信息传递的内容、计算路由的算法，可以将动态路由协议分为两大类 
>
> ​	▫ 距离矢量协议（Distance-Vector Protocol） 
>
> ​		▪ RIP 
>
> ​	▫ 链路状态协议（Link-State Protocol） 
>
> ​		▪ OSPF 
>
> ​		▪ IS-IS 
>
> ​	▫ BGP使用一种基于距离矢量算法修改后的算法，该算法被称为路径矢量（Path Vector） 算法。因此在某些场合下，BGP也被称为路径矢量路由协议。 
>
> • 根据工作范围不同，又可以分为 
>
> ​	▫ 内部网关协议IGP（Interior Gateway Protocol）:在一个自治系统内部运行。RIP、 OSPF、ISIS为常见的IGP协议。 
>
> ​	▫ 外部网关协议EGP（Exterior Gateway Protocol）：运行于不同自治系统之间。BGP 是目前最常用的EGP协议。

#### 路由汇总

##### CIDR(classless inter-domain routing无类别域间路由)

采用IP加掩码长度来标识网络和子网，不按照ABC对地址进行划分

容许任意长度的掩码长度，将IP看做连续的地址空间，可以使用任意长度的前缀分配，多个前缀可以聚合成一个网络，该特性可以有效减少路由表条目数量

![image-20241013145535353](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013145535353.png)

大规模网络，路由器要维护大量的路由表项，为了维护这些数据，会耗费大量资源。要减小设备路由表规模。使用路由汇总、也是路由聚合，是将一组有规律的路由汇聚成一条路由，从而达到减小规模以及优化设备资源利用率的问题。汇聚之前的路由称为精细路由，汇聚后的叫做汇总路由。

![image-20241013145841884](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013145841884.png)

• RTA上为了能够前往远端地址，需要为每一个远端网段配置一条明细路由。去往10.1.1.0/24、 10.1.2.0/24、10.1.3.0/24…拥有相同下一跳。将拥有相同下一跳，一组有规律的路由汇总成 一条路由，这叫做路由汇总。 

• 路由汇总可以有效减少路由表项大小。

![image-20241013145939823](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013145939823.png)

• 诀窍在于：将明细路由的目的网络地址都换算成二进制，然后排列起来，找出所有目的网 络地址中“相同的比特位”。

![image-20241013150111974](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013150111974.png)

![image-20241013150229292](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013150229292.png)

• 一般来说一条路由，无论是静态的或者是动态的，都需要关联到一个出接口，路由的出接 口指的是设备要到达一个目的网络时的出站接口。路由的出接口可以是该设备的物理接口， 例如百兆、千兆以太网接口，也可以是逻辑接口，例如VLAN接口（VLAN Interface），或 者隧道（Tunnel）接口等。在众多类型的出接口中，有一种接口非常特殊，那就是Null （无效）接口，这种类型的接口只有一个编号，也就是0。Null0是一个系统保留的逻辑接 口，当网络设备在转发某些数据包时，如果使用出接口为Null0的路由，那么这些报文将被 直接丢弃，就像被扔进了一个黑洞里，因此出接口为Null0的路由又被称为黑洞路由。

![image-20241013150321613](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013150321613.png)

![image-20241013150332893](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241013150332893.png)



## 路由高级特性

### 等价路由、浮动路由定义

#### 路由递归

![image-20241014090156682](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241014090156682.png)

• 路由必须有直连的下一跳才能够指导转发，但是路由生成时下一跳可能不是直连的，因此 需要计算出一个直连的下一跳和对应的出接口，这个过程就叫做路由递归。 

• 路由递归也被称为路由迭代。

![image-20241014090311614](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241014090311614.png)

#### 等价路由

![image-20241014090331131](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241014090331131.png)

在等价路由的前提下，才能实现对应路由之间的负载分担

#### 浮动路由-基本概念

![image-20241014090913805](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241014090913805.png)

• 静态路由支持配置时手动指定优先级，可以通过配置目的地址/掩码相同、优先级不同、 下一跳不同的静态路由，实现转发路径的备份。 

• 浮动路由是主用路由的备份，保证链路故障时提供备份路由。主用路由下一跳可达时该 备份路由不会出现在路由表。

![image-20241014091038163](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241014091038163.png)

• RTA-RTB之间的链路正常时，20.0.0.0/30的两条路由条目都是有效的条目，此时比较优先级，下一跳为10.1.1.2的优先级60，下一跳为10.1.2.2的优先级70，因此下一跳为10.1.1.2的 加入路由表。 

• RTA-RTB之间的链路故障时，10.1.1.2不可达，因此下一跳为10.1.1.2的路由失效，此时前往20.0.0.0/30的路由就只存在一条，该条路由将会被选入路由表。前往20.0.0.1的流量将会 被转发到10.1.2.2。
