# 生成树

## 生成树技术概述

### 技术背景：二层交换机网络的冗余性和环路

![image-20241002130611139](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002130611139.png)

缺乏冗余性意味着只要有一处断连，那么就会出现接入不了网的情况，那么，如果增加冗余性，就可能会出现二层环路

###  技术背景：人为错误导致的二层环路

可能是 人为错误导致的二层环路，例如设备之间的互联线缆连接错误，或者 由于·人为错误导致的二层环路 例如想要创建一个聚合链路，但是本应该被添加的链路没有被添加进来。

![image-20241002133637677](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002133637677.png)

### 二层环路带来的问题

1.广播风暴 2.MAC地址漂移

一个BUM帧Boardcast Unicast Multicast 广播 单播 组播 帧传输到交换机当中，在三个交换机之间形成回路，数据量加倍

同样的一个BUM帧带着MAC信息，会从端口上影响到其他交换机的MAC地址表

![image-20241002134739827](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002134739827.png)

### 初识生成树

![image-20241002134919916](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002134919916.png)

通过该协议去阻塞一些端口，以至于打破回路，但是端口之间的线缆依旧存在，等待如果其中的某一条通路断掉之后可以开放端口。

交换机之间会自动进行生成树协议报文的交互并进行无环拓扑运算，最后阻塞掉一些端口，打破环路

生成树协议既能解决二层环路问题，也能为网络的冗余性提供一种方案

这个主要是用来解决二层网络设备的，三层的话由于有IP报文的头部中的TTL字段可以防止报文被无止尽的转发

## STP的基本概念及工作原理

### STP基本概念：桥ID

- IEEE 802.1D中规定BID由16位的桥优先级与桥MAC构成
- 每一台运行STP的交换机都有一个唯一的BID
- BID桥优先级占据高16bit，其余低48bit是桥MAC地址
- 在STP网络中，BID最小的设备会被选举为根桥

![image-20241002141509128](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002141509128.png)

### STP基本概念：根桥

STP主要作用是在整个交换网络中计算出一颗无环树，根桥即树根

在STP中，桥ID最小的设备会被选举为根桥

​	首先比较桥优先级，优先级越小，越优先。

​	相等的话再比较MAC地址，最小MAC地址优先成为根桥

### STP基本概念：Cost

- 接口的Cost用于计算根路径开销，也就是到达根的开销
- 接口的缺省cost除了和速率，工作模式有关，还和交换机使用的STP Cost计算方法有关
- 接口带宽越大，则Cost值越小
- 也可以根据需要通过命令调整接口的Cost

### STP基本概念：Cost计算方法

![image-20241003113254362](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113254362.png)

### STP的基本概念：RPC(Root Path Cost)

一台设备从某个接口到达根桥的根路径开销等于从根桥到该设备沿途所有入方向接口的Cost累加

![image-20241003113431632](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113431632.png)

### STP的基本概念：PortID

![image-20241003113456119](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113456119.png)

### STP的基本概念：BPDU(Bridge Protocol Data Unit)

是STP的协议报文

分两种类型

- 配置BPDU
- TCN BPDU(Topology Change Notification BPDU)

配置BPDU是STP进行拓扑计算的关键

TCN BPDU只在网络拓扑发生变更时才会被触发

![image-20241003115602769](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115602769.png)

![image-20241003115712307](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115712307.png)

![image-20241003115743259](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115743259.png)

### 生成树工作过程

![image-20241003132102676](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132102676.png)

>  • 什么是根桥？ 
>
> ​	▫ 根桥是STP树的根节点。
>
> ​	▫ 要生成一棵STP树，首先要确定出一个根桥。 
>
> ​	▫ 根桥是整个交换网络的逻辑中心，但不一定是它的物理中心。 
>
> ​	▫ 当网络的拓扑发生变化时，根桥也可能发生变化。（抢占）
>
>  • 选举过程：
>
> ​	▫ STP交换机初始启动之后，都会认为自己是根桥，并在发送给其他交换机的BPDU中 宣告自己为根桥。因此，此时BPDU中的根桥ID为各自设备的网桥ID。 
>
> ​	▫ 当交换机收到网络中其他设备发送来的BPDU后，会比较BPDU中的根桥ID和自己的 BID。 
>
> ​	▫ 交换机不断交互BPDU，同时对BID进行比较，最终选举一台BID最小的交换机作为根 桥，其他的则为非根桥。 
>
> ​	▫ 如图：根桥的选举先比较优先级，交换机SW1、2、3的优先级相等，则比较MAC地 址，也优选最小的，所以SW1的BID最小，因此SW1为根桥，SW2和SW3为非根桥。
>
>  • 注意： 
>
> ​	▫ 根桥的角色可抢占。当有更优的BID的交换机加入网络时，网络会重新进行STP计算， 选出新的根桥。

![image-20241003132114750](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132114750.png)

> • 什么是根端口？
>
> ​	▫ 一个非根桥设备上会有多个端口与网络相连，为了保证从某台非根桥设备到根桥设备 的工作路径是最优且唯一的，就必须从该非根桥设备的端口中确定出一个被称为“根 端口”的端口，由根端口来作为该非根桥设备与根桥设备之间进行报文交互的端口。 
>
> ​	▫ 在选举出根桥后，根桥仍然持续发送BPDU，而非根桥将持续不断的收到根桥发送的 BPDU。因此，在所有非根桥上选举一个距离根桥“最近”的端口（根端口），在网 络收敛后，根端口将不断的收到来自根桥的BPDU。
>
> ​	▫ 即：根端口保证了交换机与根桥之间工作路径的唯一性和最优性。
>
> • 注意：一个非根桥设备上，最多只能有一个根端口。
>
> • 选举过程： 
>
> 1. 交换机有多个端口接入网络，各个端口都会收到BPDU报文，报文中会携带“RootID、 RPC、BID、PID”等关键字段，端口会针对这些字段进行PK。
>
> 2. 首先比较根路径开销（RPC），STP协议把根路径开销作为确定根端口的重要依据。 RPC值越小，越优选，因此交换机会选RPC最小的端口作为根端口。
>
> 3. 当RPC相同时，比较上行交换机的BID，即比较交换机各个端口收到的BPDU中的BID， 值越小，越优选，因此交换机会选上行设备BID最小的端口作为根端口。	
>
>  	4. 当上行交换机BID相同时，比较上行交换机的PID，即比较交换机各个端口收到的 BPDU中的PID，值越小，越优先，因此交换机会选上行设备PID最小的端口作为根端 口。
>  	5. 当上行交换机的PID相同时，则比较本地交换机的PID，即比较本端交换机各个端口 各自的PID，值越小，越优先，因此交换机会选端口PID最小的端口作为根端口。

> • 什么是指定端口？ 
>
> ​	▫ 网络中的每个链路与根桥之间的工作路径必须是唯一的且最优的。当一个链路有两条 及以上的路径通往根桥时（该链路连接了不同的交换机，或者该链路连接了同一台交 换机的不同端口），与该链路相连的交换机（可能不止一台）就必须确定出一个唯一 的指定端口。 
>
> ​	▫ 因此，每个链路（Link）选举一个指定端口，用于向这个链路发送BPDU。
>
> • 注意：一般情况下，根桥上不存在任何根端口，只存在指定端口。
>
> • 选举过程： 指定端口也是通过比较RPC来确定的，选择RPC最小的作为指定端口，如果RPC相同，则 比较BID和PID。 
>
> 	1. 首先比较根路径开销（RPC），值越小，越优选，因此交换机会选RPC最小的端口作 为指定端口。 
> 	1. 若RPC相等，则比较链路两端交换机的BID，值越小，越优选，因此交换机会选BID 最小的交换机的端口作为指定端口。 
> 	1. 若BID相等，则比较链路两端端口的PID，值越小，越优选，因此交换机会选PID最小 的交换机的端口作为指定端口。

> • 什么是非指定端口（预备端口）？
>
> • 在确定了根端口和指定端口之后，交换机上所有剩余的非根端口和非指定端口统称为预备 端口。 
>
> • 阻塞非指定端口 
>
> ​	▫ STP会对这些非指定端口进行逻辑阻塞，即这些端口不能转发由终端计算机产生并发 送的帧（用户数据帧）。 
>
> ​	▫ 一旦非指定端口被逻辑阻塞后，STP树（无环路工作拓扑）就生成了。 
>
> • 注意： 
>
> ​	▫ **非指定端口可以接收并处理BPDU。** 
>
> ​	▫ 根端口和指定端口既可以接收和发送BPDU，也可以转发用户数据帧。



![image-20241003132125967](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132125967.png)

> • 图中所示为STP的端口状态迁移机制，运行STP协议的设备上端口状态有5种： 
>
> ​	▫ Forwarding：转发状态。端口既可转发用户流量也可转发BPDU报文，只有根端口或指定端口才能进入Forwarding状态。 
>
> ​	▫ Learning：学习状态。端口可根据收到的用户流量构建MAC地址表，但不转发用户流量。增加Learning状态是为了防止临时环路。 
>
> ​	▫ Listening：侦听状态。端口可以转发BPDU报文，但不能转发用户流量。 
>
> ​	▫ Blocking：阻塞状态。端口仅仅能接收并处理BPDU，不能转发BPDU，也不能转发用 户流量。此状态是预备端口的最终状态。 
>
> ​	▫ Disabled：禁用状态。端口既不处理和转发BPDU报文，也不转发用户流量。

### 拓扑变化

![image-20241003133455730](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003133455730.png)

> • 根桥故障： 
>
> ​	▫ 在稳定的STP网络，非根桥会定期收到来自根桥的BPDU报文。 
>
> ​	▫ 如果根桥发生了故障，停止发送BPDU，下游交换机就无法收到来自根桥的BPDU报文。 
>
> ​	▫ 如果下游交换机一直收不到BPDU报文，Max Age计时器（缺省: 20s）就会超时，从 而导致已经收到的BPDU报文失效，此时，非根桥会互相发送配置BPDU，重新选举新的根桥。 
>
> • 端口状态： 
>
> ​	▫ SW3的预备端口，20s后会从Blocking状态进入到Listening状态，再进入Learning状 态，最终进入到Forwarding状态，进行用户流量的转发。 
>
> • 收敛时间： 
>
> ​	▫ 根桥故障会导致50s左右的恢复时间，等于Max Age加上2倍的Forward Delay收敛时 间。

![image-20241003203539123](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003203539123.png)

> • 直连链路故障： 
>
> ​	▫ 当两台交换机间用两条链路互连时，其中一条是主用链路，另一条为备用链路。 
>
> ​	▫ 当网络稳定时，交换机SWB检测到根端口的链路发生故障，则其备用端口会进入用户 流量转发状态。 
>
> • 端口状态： 
>
> ​	▫ 备用端口会从Blocking状态，迁移到Listening-Learning-Forwarding状态。 
>
> ​	▫ 收敛时间： 
>
> ​	▫ 直连链路故障，备用端口会经过30s后恢复转发状态。

![image-20241003204311749](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003204311749.png)

> • 非直连故障 
>
> ​	▫ 在稳定的STP网络，非根桥会定期收到来自根桥的BPDU报文。 
>
> ​	▫ 若SW1与SW2之间的链路发生了某种故障（非物理故障），因此SW2一直收不到来自 根桥SW1的BPDU报文，Max Age计时器（缺省: 20 s）就会超时，从而导致已经收到 的BPDU报文失效。 
>
> ​	▫ 此时，非根桥SW2会认为根桥失效，并且认为自己是根桥，从而发送自己的配置 BPDU给SW3，通知SW3自己是新的根桥。 
>
> ​	▫ 在此期间，SW3的预备端口一直收不到包含根桥ID的BPDU，Max Age计时器超时后， 端口进入到Listening状态，开始向SW2“转发”从上游发来的包含根桥ID的BPDU。 
>
> ​	▫ 因此，Max Age定时器超时后，SW2和SW3几乎同时收到对方发来的BPDU，再进行 STP重新计算，SW2发现SW3发来的BPDU更优，就放弃宣称自己是根桥并重新确定 端口角色。 
>
> • 端口状态： 
>
> ​	▫ SW3预备端口20s后会从Blocking状态进入到Listening状态，再进入Learning状态，最终进入到Forwarding状态，进行用户流量的转发。 
>
> • 收敛时间： 
>
> ​	▫ 非直连故障会导致50s左右的恢复时间，等于Max Age加上2倍的Forward Delay收敛时间。

![image-20241003204636387](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003204636387.png)

> • 在交换网络中，交换机依赖MAC地址表转发数据帧。缺省情况下，MAC地址表项的老化时 间是300秒。如果生成树拓扑发生变化，交换机转发数据的路径也会随着发生改变，此时MAC地址表中未及时老化掉的表项会导致数据转发错误，因此在拓扑发生变化后需要及时 更新MAC地址表项。 
>
> • 本例中，SW2中的MAC地址表项定义了通过端口GigabitEthernet 0/0/1可以到达主机A，通过端口GigabitEthernet0/0/3可以到达主机B。由于SW3的根端口产生故障，导致生成树拓 扑重新收敛，在生成树拓扑完成收敛之后，从主机A到主机B的帧仍然不能到达目的地。这 是因为MAC地址表项老化时间是300秒，主机A发往主机B的帧到达SW2后，SW2会继续通 过端口GigabitEthernet 0/0/3转发该数据帧。

![image-20241003204911322](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003204911322.png)

> TC = Topology Change TCA = TC Accept
>
> • 拓扑变化过程中，根桥通过TCN BPDU报文获知生成树拓扑里发生了故障。根桥生成TC用 来通知其他交换机加速老化现有的MAC地址表项。 
>
> • 拓扑变更以及MAC地址表项更新的具体过程如下： 
>
> ​	▫ SW3感知到网络拓扑发生变化后，会不间断地向SWB发送TCN BPDU报文。 
>
> ​	▫ SW2收到SW3发来的TCN BPDU报文后，会把配置BPDU报文中的Flags的TCA位设置1，然后发送给SW3，告知SW3停止发送TCN BPDU报文。 
> ​	▫ SW2向根桥转发TCN BPDU报文。 
>
> ​	▫ SW1把配置BPDU报文中的Flags的TC位设置为1后发送，通知下游设备把MAC地址表 项的老化时间由默认的300 s修改为Forward Delay的时间（默认为15 s）。 
>
> ​	▫ 最多等待15 s之后，SW2中的错误MAC地址表项会被自动清除。此后，SW2就能重新开始MAC表项的学习及转发操作。

## STP的基础配置

### STP的基础配置命令

1.配置生成树工作模式

***

[Huawei] stp mode {stp|rstp|mstp}

***

支持上述三种工作模式，默认情况工作在MSTP模式

2.(可选)配置根桥

***

[Huawei]**stp root primary**

***

配置当前设备为根桥，缺省情况下，交换机不作为任何生成树的根桥，配置后该设备优先级数值自动为0，并且不能更改设备优先级。

3.(可选)配置备份根桥

***

[Huawei]**stp root secondary**

***

配置当前交换机为备份根桥，同样缺省状态下不作为任何生成树的备份根桥，配置后该设备优先级数值为4096，且不能更改优先级。

4.(可选)配置交换机的stp优先级

***

[Huawei]**stp priority** *priority*

***

缺省情况下，交换机的优先级取值是32768 提升一级要-4096

5.(可选)配置接口路径开销

***

[Huawei]**stp pathcost-standard** {**dot1d-1998|dot1t|legacy}

***

配置接口路径开销计算方法，缺省情况下，路径开销值的计算方法为IEEE802.11t(dot1t)标准方法，同一网络内所有交换机的接口路径开销应使用相同的计算方法

***

[Huawei]**stp cost** *cost*

***

设置当前接口的路径开销值

6.(可选)配置接口优先级

***

[Huawei-intf]**stp priority** *priority*

***

配置接口的优先级，缺省情况下，交换机的接口优先级是128

7.启用STP/RSTP/MSTP

***

[Huawei]**stp enable**

***

使能交换机的STP/RSTP/MSTP功能，缺省情况下，设备的这些功能属于启用状态

## RSTP对STP的改进

### STP不足之处

解决环路，但是速度慢，影响通信质量

没有细致区分接口状态和接口角色，不利于学习和部署

网络协议的优劣往往取决于协议是否对各种情况加以细致区分。 

​	▫ 从用户角度来讲，Listening、Learning和Blocking状态并没有区别，都同样不转发用户流量。 

​	▫ 从使用和配置角度来讲，接口之间最本质的区别并不在于接口状态，而是在于接口扮演的角色。 

​	▫ 根接口和指定接口可以都处于Listening状态，也可能都处于Forwarding状态。 

• STP算法是被动的算法，依赖定时器等待的方式判断拓扑变化，收敛速度慢。 

• STP算法要求在稳定的拓扑中，根桥主动发出配置BPDU报文，而其他设备进行处理，传遍整个STP网络。这 也是导致拓扑收敛慢的主要原因之一。

### RSTP概述

STP的基础上改进了，优化并兼容，且速度更快

引入了新的接口角色 备份端口和边缘端口

状态规范只有三种

### 其他改进

配置BPDU的处理发生变化

​	拓扑稳定后，配置BPDU报文的发送方式进行了优化

​	使用更短的BPDU超时计时

​	对处理次等BPDU的方式进行了优化

配置BPDU格式的改变，充分利用了STP协议中的Flag字段，明确了接口角色。

![image-20241004115618286](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004115618286.png)

![image-20241004115633879](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004115633879.png)

![image-20241004115812721](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004115812721.png)

## 生成树协议进阶

### STP/RSTP缺陷：所有VLAN共享一颗生成树



![image-20241004120356437](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004120356437.png)

- RSTP的本质还是STP
- 所以缺陷依旧还是一样的，局域网内所有的VLAN共享一棵生成树，因此无法在VLAN间实现数据流量的负载均衡，链路被阻塞后不承载任何流量，可能造成部分VLAN的报文无法转发。



### VBST：基于VLAN的生成树

![image-20241004121300713](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004121300713.png)

> • 企业网中部署VBST： 
>
> ​	▫ 可消除网络中可能存在的通信环路。 
>
> ​	▫ 可实现链路的复用和流量的负载分担，进而有效地提高链路带宽的利用率。 
>
> ​	▫ 配置和维护简单，进而可降低配置和维护成本。 
>
> • 但是如果网络中VLAN的数量较多，为每个VLAN执行独立的生成树计算将耗费交换机大量的资源。 
>
> • 华为公司提出了VBST（VLAN-Based Spanning Tree）生成树解决方案。该解决方案中，生成树的形成是基于VLAN的，不同VLAN间可形成相互独立的生成树，不同VLAN内的流量沿着各自的生成树转发，进而可实现流量的负载分担

### MSTP:多生成树

![image-20241004121507832](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004121507832.png)

弥补STP类的缺陷，IEEE802.1s中定义了MSTP 2002年

兼容STP和RSTP 既可以快速收敛，又提供了数据转发的多个冗余路径，在转发过程中实现VLAN数据的负载均衡

### MSTP概述

• MSTP把一个交换网络划分成多个域，每个域内形成多棵生成树，生成树之间彼此独立。 

• 每棵生成树叫做一个多生成树实例MSTI（Multiple Spanning Tree Instance）。 

• 所谓生成树实例就是多个VLAN的集合所对应的生成树。 

• 通过将多个VLAN捆绑到一个实例，可以节省通信开销和资源占用率。 

• MSTP各个实例拓扑的计算相互独立，在这些实例上可以实现负载均衡。 

• 可以把多个相同拓扑结构的VLAN映射到一个实例里，这些VLAN在接口上的转发状态取决 于接口在对应实例的状态。

### 堆叠和园区网络树形结构组网形态

![image-20241004123014891](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004123014891.png)

> • 堆叠iStack（Intelligent Stack），是指将多台支持堆叠特性的交换机设备组合在一起，从 逻辑上组合成一台整体交换设备。 
>
> • 堆叠系统建立之前，每台交换机都是单独的实体，有自己独立的IP地址和MAC地址，对外 体现为多台交换机，用户需要独立的管理所有的交换机；堆叠建立后堆叠成员对外体现为 一个统一的逻辑实体，用户使用一个IP地址对堆叠中的所有交换机进行管理和维护，如图所示。通过交换机堆叠，可以实现**网络大数据量转发和网络高可靠性，同时简化网络管理**

### Smart Link

![image-20241004123331652](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241004123331652.png)

> • 如图所示Switch3采用双上行方式分别连接到FW1和FW2，这样Switch3到达上行的链路就可以有两条。在Switch3上配置Smart Link，正常情况下，可实现Port2所在链路作为Port1 所在链路的备份。若Port1所在的链路发生故障，Smart Link会自动将数据流量切换到Port2 所在链路，保证业务不中断。 
>
> • Smart Link是一种为双上行组网量身定做的解决方案： 
>
> ​	▫ 在双向行的设备上部署，当网络正常时，两条上行链路中， 一条处于活跃状态，而另一条则处于备份状态（不承载业 务流量）。如此一来二层环路就此打破。 
>
> ​	▫ 当主用链路发生故障后，流量会在毫秒级的时间内迅速切 换到备用链路上，保证了数据的正常转发。 
>
> ​	▫ Smart Link配置简单，便于用户操作。 
>
> ​	▫ 无需协议报文交互，收敛速度及可靠性大大提升

## 总结

• 生成树是一个用于局域网中消除环路的协议。运行该协议的设备通过彼此交互信息而发现网络中的环路，并对某些接口进行阻塞以消除环路。由于局域网规模的不断增长，生成树协议已经成为 了当前最重要的局域网协议之一。 

• 在以太网交换网中部署生成树协议后，如果网络 中出现环路，生成树协议通过拓扑计算，可实现： 

​	▫ 消除环路：通过阻塞冗余链路消除网络中可能存在 的网络通信环路。 

​	▫ 链路备份：当前活动的路径发生故障时，激活冗余 备份链路，恢复网络连通性。 

• RSTP（Rapid Spanning-Tree Protocol）作为一种 存在已久的协议，已经无法满足现代园区网络的需求，但是了解STP的工作原理，有助于为进一步熟悉并掌握RSTP及MSTP的原理与部 署做好铺垫
