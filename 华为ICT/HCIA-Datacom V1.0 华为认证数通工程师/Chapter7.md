# 生成树

## 生成树技术概述

### 技术背景：二层交换机网络的冗余性和环路

![image-20241002130611139](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002130611139.png)

缺乏冗余性意味着只要有一处断连，那么就会出现接入不了网的情况，那么，如果增加冗余性，就可能会出现二层环路

###  技术背景：人为错误导致的二层环路

可能是 人为错误导致的二层环路，例如设备之间的互联线缆连接错误，或者 由于·人为错误导致的二层环路 例如想要创建一个聚合链路，但是本应该被添加的链路没有被添加进来。

![image-20241002133637677](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002133637677.png)

### 二层环路带来的问题

1.广播风暴 2.MAC地址漂移

一个BUM帧Boardcast Unicast Multicast 广播 单播 组播 帧传输到交换机当中，在三个交换机之间形成回路，数据量加倍

同样的一个BUM帧带着MAC信息，会从端口上影响到其他交换机的MAC地址表

![image-20241002134739827](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002134739827.png)

### 初识生成树

![image-20241002134919916](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002134919916.png)

通过该协议去阻塞一些端口，以至于打破回路，但是端口之间的线缆依旧存在，等待如果其中的某一条通路断掉之后可以开放端口。

交换机之间会自动进行生成树协议报文的交互并进行无环拓扑运算，最后阻塞掉一些端口，打破环路

生成树协议既能解决二层环路问题，也能为网络的冗余性提供一种方案

这个主要是用来解决二层网络设备的，三层的话由于有IP报文的头部中的TTL字段可以防止报文被无止尽的转发

## STP的基本概念及工作原理

### STP基本概念：桥ID

- IEEE 802.1D中规定BID由16位的桥优先级与桥MAC构成
- 每一台运行STP的交换机都有一个唯一的BID
- BID桥优先级占据高16bit，其余低48bit是桥MAC地址
- 在STP网络中，BID最小的设备会被选举为根桥

![image-20241002141509128](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241002141509128.png)

### STP基本概念：根桥

STP主要作用是在整个交换网络中计算出一颗无环树，根桥即树根

在STP中，桥ID最小的设备会被选举为根桥

​	首先比较桥优先级，优先级越小，越优先。

​	相等的话再比较MAC地址，最小MAC地址优先成为根桥

### STP基本概念：Cost

- 接口的Cost用于计算根路径开销，也就是到达根的开销
- 接口的缺省cost除了和速率，工作模式有关，还和交换机使用的STP Cost计算方法有关
- 接口带宽越大，则Cost值越小
- 也可以根据需要通过命令调整接口的Cost

### STP基本概念：Cost计算方法

![image-20241003113254362](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113254362.png)

### STP的基本概念：RPC(Root Path Cost)

一台设备从某个接口到达根桥的根路径开销等于从根桥到该设备沿途所有入方向接口的Cost累加

![image-20241003113431632](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113431632.png)

### STP的基本概念：PortID

![image-20241003113456119](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003113456119.png)

### STP的基本概念：BPDU(Bridge Protocol Data Unit)

是STP的协议报文

分两种类型

- 配置BPDU
- TCN BPDU(Topology Change Notification BPDU)

配置BPDU是STP进行拓扑计算的关键

TCN BPDU只在网络拓扑发生变更时才会被触发

![image-20241003115602769](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115602769.png)

![image-20241003115712307](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115712307.png)

![image-20241003115743259](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003115743259.png)

### 生成树工作过程

![image-20241003132102676](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132102676.png)

>  • 什么是根桥？ 
>
> ​	▫ 根桥是STP树的根节点。
>
> ​	▫ 要生成一棵STP树，首先要确定出一个根桥。 
>
> ​	▫ 根桥是整个交换网络的逻辑中心，但不一定是它的物理中心。 
>
> ​	▫ 当网络的拓扑发生变化时，根桥也可能发生变化。（抢占）
>
>  • 选举过程：
>
> ​	▫ STP交换机初始启动之后，都会认为自己是根桥，并在发送给其他交换机的BPDU中 宣告自己为根桥。因此，此时BPDU中的根桥ID为各自设备的网桥ID。 
>
> ​	▫ 当交换机收到网络中其他设备发送来的BPDU后，会比较BPDU中的根桥ID和自己的 BID。 
>
> ​	▫ 交换机不断交互BPDU，同时对BID进行比较，最终选举一台BID最小的交换机作为根 桥，其他的则为非根桥。 
>
> ​	▫ 如图：根桥的选举先比较优先级，交换机SW1、2、3的优先级相等，则比较MAC地 址，也优选最小的，所以SW1的BID最小，因此SW1为根桥，SW2和SW3为非根桥。
>
>  • 注意： 
>
> ​	▫ 根桥的角色可抢占。当有更优的BID的交换机加入网络时，网络会重新进行STP计算， 选出新的根桥。

![image-20241003132114750](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132114750.png)

> • 什么是根端口？
>
> ​	▫ 一个非根桥设备上会有多个端口与网络相连，为了保证从某台非根桥设备到根桥设备 的工作路径是最优且唯一的，就必须从该非根桥设备的端口中确定出一个被称为“根 端口”的端口，由根端口来作为该非根桥设备与根桥设备之间进行报文交互的端口。 
>
> ​	▫ 在选举出根桥后，根桥仍然持续发送BPDU，而非根桥将持续不断的收到根桥发送的 BPDU。因此，在所有非根桥上选举一个距离根桥“最近”的端口（根端口），在网 络收敛后，根端口将不断的收到来自根桥的BPDU。
>
> ​	▫ 即：根端口保证了交换机与根桥之间工作路径的唯一性和最优性。
>
> • 注意：一个非根桥设备上，最多只能有一个根端口。
>
> • 选举过程： 
>
> 1. 交换机有多个端口接入网络，各个端口都会收到BPDU报文，报文中会携带“RootID、 RPC、BID、PID”等关键字段，端口会针对这些字段进行PK。
>
> 2. 首先比较根路径开销（RPC），STP协议把根路径开销作为确定根端口的重要依据。 RPC值越小，越优选，因此交换机会选RPC最小的端口作为根端口。
>
> 3. 当RPC相同时，比较上行交换机的BID，即比较交换机各个端口收到的BPDU中的BID， 值越小，越优选，因此交换机会选上行设备BID最小的端口作为根端口。	
>
>  	4. 当上行交换机BID相同时，比较上行交换机的PID，即比较交换机各个端口收到的 BPDU中的PID，值越小，越优先，因此交换机会选上行设备PID最小的端口作为根端 口。
>  	5. 当上行交换机的PID相同时，则比较本地交换机的PID，即比较本端交换机各个端口 各自的PID，值越小，越优先，因此交换机会选端口PID最小的端口作为根端口。

> • 什么是指定端口？ 
>
> ​	▫ 网络中的每个链路与根桥之间的工作路径必须是唯一的且最优的。当一个链路有两条 及以上的路径通往根桥时（该链路连接了不同的交换机，或者该链路连接了同一台交 换机的不同端口），与该链路相连的交换机（可能不止一台）就必须确定出一个唯一 的指定端口。 
>
> ​	▫ 因此，每个链路（Link）选举一个指定端口，用于向这个链路发送BPDU。
>
> • 注意：一般情况下，根桥上不存在任何根端口，只存在指定端口。
>
> • 选举过程： 指定端口也是通过比较RPC来确定的，选择RPC最小的作为指定端口，如果RPC相同，则 比较BID和PID。 
>
> 	1. 首先比较根路径开销（RPC），值越小，越优选，因此交换机会选RPC最小的端口作 为指定端口。 
> 	1. 若RPC相等，则比较链路两端交换机的BID，值越小，越优选，因此交换机会选BID 最小的交换机的端口作为指定端口。 
> 	1. 若BID相等，则比较链路两端端口的PID，值越小，越优选，因此交换机会选PID最小 的交换机的端口作为指定端口。

> • 什么是非指定端口（预备端口）？
>
> • 在确定了根端口和指定端口之后，交换机上所有剩余的非根端口和非指定端口统称为预备 端口。 
>
> • 阻塞非指定端口 
>
> ​	▫ STP会对这些非指定端口进行逻辑阻塞，即这些端口不能转发由终端计算机产生并发 送的帧（用户数据帧）。 
>
> ​	▫ 一旦非指定端口被逻辑阻塞后，STP树（无环路工作拓扑）就生成了。 
>
> • 注意： 
>
> ​	▫ 非指定端口可以接收并处理BPDU。 
>
> ​	▫ 根端口和指定端口既可以接收和发送BPDU，也可以转发用户数据帧。



![image-20241003132125967](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003132125967.png)

### 拓扑变化

![image-20241003133455730](./../../../../../AppData/Roaming/Typora/typora-user-images/image-20241003133455730.png)



## STP的基础配置

## RSTP对STP的改进

## 生成树协议进阶



